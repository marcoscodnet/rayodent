<?phpclass PDFEtiquetaMovCajaAction extends Action {    protected function getOrdenpractica() {        $cd_movcaja = FormatUtils::getParam('id', 0);        $criterio = new CriterioBusqueda();        $criterio->addFiltro("OP.cd_movcaja", $cd_movcaja, "=");        $manager = new OrdenpracticaManager();        $oOrdenPractica = $manager->getOrdenpractica($criterio);        return $oOrdenPractica;    }    protected function getTitulo() {        return 'Movimiento de Caja';    }    public function execute() {        try {            $this->execute_pdf();        } catch (GenericException $ex) {            //CdtUtils::log_debug("No se puede imprimir la etiqueta porque no hay una pr�ctica.");            $forward = $this->getForwardError();            $this->setDs_forward_params('er=1' . '&msg=' . $ex->getMessage() . '&code=' . $ex->getCode());            return $forward;        }    }    public function execute_pdf() {        //tipo de la copia del remito.        $cd_movcaja = FormatUtils::getParam('id', 0);                $oOrdenpractica = $this->getOrdenpractica();        if (!empty($oOrdenpractica)) {			$criterio = new CriterioBusqueda();	        $criterio->addFiltro("MC.cd_movcaja", $cd_movcaja, "=");		        $movcajaManager = new MovcajaManager();		        $oMovcaja = $movcajaManager->getMovcaja($criterio);	        $etiqueta = $oMovcaja->getNu_etiquetasimple()+1;	        $oMovcaja->setNu_etiquetasimple($etiqueta);	        $movcajaManager->modificarMovcaja($oMovcaja,1);            //$pdf = new PDFPrint('P', 'mm', array(80, 50));            //$pdf = new PDFPrint('P', 'mm', array(75, 45));            $pdf = new PDFPrint('L', 'cm', array(5, 8));            $pdf = $this->generarEtiqueta($pdf, $oOrdenpractica, $cd_movcaja);            //para que no haga el forward.            $pdf->Output("etiqueta_$cd_movcaja.pdf", 'D');        } else {            throw new GenericException("No se imprimió la etiqueta porque el movimiento no tiene prácticas");        }    }    public function generarEtiqueta($pdf, $oOrdenpractica, $cd_movcaja) {        //armamos el pdf.        $pdf->SetFont('Arial', '', 14);        $pdf->AddPage();        //Margin top        $pdf->SetTopMargin(1);        $pdf->SetY(0.1);        $pdf->SetLeftMargin(0.1);        $pdf->SetX(0.1	);        $pdf->SetAutoPageBreak(false);        $pdf->Cell(2, 0.5, "Paciente: ", 0, 0, 'L');        $info_paciente = $oOrdenpractica->getPaciente()->getDs_apynom() . " (" . $oOrdenpractica->getCd_paciente() . ")";        $pdf->SetFont('Arial', 'B', 14);        $pdf->MultiCell(5.5, 0.5, $info_paciente, 0, 'L', 0);        $pdf->SetFont('Arial', '', 14);        $pdf->Cell(2.55, 0.5, "Profesional: ", 0, 0, 'L');        $pdf->MultiCell(5.5, 0.5, $oOrdenpractica->getProfesional()->getDs_nombre(), 0, 'L', 0);        $pdf->Cell(2, 0.5, "Fecha: ", 0, 0, 'L');        $datetime = explode(" ", FuncionesComunes::fechaHoraMysqlaPHP($oOrdenpractica->getMovcaja()->getDt_movcaja()));        $pdf->Cell(3, 0.5, $datetime[0], 0, 1, 'L');        $this->parsePracticas($pdf, $oOrdenpractica);        return $pdf;    }    public function parsePracticas($pdf, $oOrdenpractica) {        $cd_movcaja = FormatUtils::getParam('id', 0);        if ($cd_movcaja != 0) {            $oPracticaOrdenPracticaManager = new PracticaordenpracticaManager();            $oMovcajaconceptoManager = new MovcajaconceptoManager();            $criterio = new CriterioBusqueda();            $criterio->addFiltro("MC.cd_movcaja", $cd_movcaja, "=");            $movcajaconceptos = $oMovcajaconceptoManager->getMovcajaconceptos($criterio);            $i = 0;            $contenido = "";            foreach ($movcajaconceptos as $movcajaconcepto) {                $criterio_practica = new CriterioBusqueda();                $criterio_practica->addFiltro("MCC.cd_movcajaconcepto", $movcajaconcepto->getCd_movcajaconcepto(), "=");                $oPracticaOrdenPractica = $oPracticaOrdenPracticaManager->getPracticaordenpractica($criterio_practica);                if ($oPracticaOrdenPractica != false) {                    $witdh = strlen($oPracticaOrdenPractica->getPracticaobrasocial()->getPractica()->getDs_practica());                    $pieza = ($oPracticaOrdenPractica->getDs_pieza())?"\n". $oPracticaOrdenPractica->getDs_pieza()."\n":"";                    if ($i == 0) {                    	                        $contenido .= "RX " . $oPracticaOrdenPractica->getPracticaobrasocial()->getPractica()->getDs_practica().$pieza;                        $i++;                    } else {                        $contenido .= " | RX " . $oPracticaOrdenPractica->getPracticaobrasocial()->getPractica()->getDs_practica().$pieza;                    }                }            }            $pdf->MultiCell(6, 0.4, $contenido);        }    }    protected function getContenido() {        return false;    }    public function getForwardError() {        return "pdf_etiqueta_movcaja_error";    }}